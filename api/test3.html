<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>图像合成</title>
</head>

<body>
    <button onclick="mergeImages()">点击合成</button>
    <script>
        // 修改为你的代理服务器地址
        const PROXY_SERVER_URL = 'http://localhost:3000'; // 根据你的实际情况修改

        // 常量定义
        const TARGET_IMAGE_URL = "1.png"; // 本地图像文件，请确保与HTML文件位于同一目录下
        const TEMPLATE_IMAGE_URL = "2.png"; // 本地图像文件，请确保与HTML文件位于同一目录下

        // 将图像文件转换为base64编码
        async function imageToBase64(imageURL) {
            const response = await fetch(imageURL);
            const blob = await response.blob();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // 获取base64编码的图像数据
        let TARGET_IMAGE_BASE64;
        let TEMPLATE_IMAGE_BASE64;

        async function initializeImages() {
            TARGET_IMAGE_BASE64 = await imageToBase64(TARGET_IMAGE_URL);
            TEMPLATE_IMAGE_BASE64 = await imageToBase64(TEMPLATE_IMAGE_URL);
        }

        // 发送获取 Access Token 请求到代理服务器
        async function getAccessToken() {
            try {
                const response = await fetch(`${PROXY_SERVER_URL}/getAccessToken`);
                const data = await response.json();
                return data.access_token;
            } catch (error) {
                throw new Error('获取 Access Token 失败');
            }
        }

        // 发送图像合成请求到代理服务器
        async function sendMergeRequest(accessToken) {
            try {
                const url = `${PROXY_SERVER_URL}/mergeImages?access_token=${accessToken}`;

                const requestBody = {
                    image_target: TARGET_IMAGE_BASE64,
                    image_template: TEMPLATE_IMAGE_BASE64,
                    image_type: 'BASE64', // 告诉服务器图像数据是base64编码
                    quality_control: 'NONE',
                    version: '2.0',
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody), // 将图像数据作为JSON发送
                });

                return response.json();
            } catch (error) {
                throw new Error('发送图像合成请求失败');
            }
        }

        // 处理图像合成结果
        function handleMergeResponse(response) {
            console.log(response);
            if (response.error_code === 0) {
                alert('图像合成成功！');
            } else {
                alert('图像合成失败：' + response.error_msg);
            }
        }

        // 合成图像函数
        async function mergeImages() {
            try {
                // 获取 Access Token
                const accessToken = await getAccessToken();

                // 发送合成请求
                const response = await sendMergeRequest(accessToken);

                // 处理合成结果
                handleMergeResponse(response);
            } catch (error) {
                console.error('合成图像时出错：', error);
                alert('图像合成发生错误，请查看控制台以获取更多信息。');
            }
        }

        // 初始化图像数据
        initializeImages();
    </script>
</body>

</html>